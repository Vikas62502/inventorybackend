name: CI/CD Pipeline of backend (master only)

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: yarn install

      - name: Build Docker image
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/cbpl-backend:master
          docker build --build-arg NODE_ENV=master -t $IMAGE_NAME .

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Push image to Docker Hub
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/cbpl-backend:master
          docker push $IMAGE_NAME

      - name: âœ… Done
        run: echo "Image pushed to Docker Hub for master"

      - name: Create .env file on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ${{ secrets.EC2_DEPLOY_PATH || '/opt/chairbord-api' }}
            cat > .env << EOF
            # Database Configuration
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_SSL=${{ secrets.DB_SSL || 'false' }}
            DB_SSL_REJECT_UNAUTHORIZED=${{ secrets.DB_SSL_REJECT_UNAUTHORIZED || 'true' }}
            
            # Application Configuration
            PORT=${{ secrets.PORT || '3001' }}
            NODE_ENV=master
            
            # JWT Configuration
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRE=${{ secrets.JWT_EXPIRE || '7d' }}
            
            # Loki Logging Configuration
            LOKI_HOST_IP=${{ secrets.LOKI_HOST_IP || '' }}
            LOKI_JOB_NAME=${{ secrets.LOKI_JOB_NAME || 'Solar_Inventory' }}
            LOG_LEVEL=${{ secrets.LOG_LEVEL || 'info' }}
            
            # Production URL
            PROD_URL=${{ secrets.PROD_URL || '' }}
            EOF
            chmod 600 .env

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/cbpl-backend:master
            PORTS="-p 3001:3001"
            CONTAINER_NAME="cbpl-live"
            DEPLOY_PATH=${{ secrets.EC2_DEPLOY_PATH || '/opt/chairbord-api' }}

            cd $DEPLOY_PATH
            sudo docker pull $IMAGE_NAME
            sudo docker stop $CONTAINER_NAME || true
            sudo docker rm $CONTAINER_NAME || true
            sudo docker run -d --name $CONTAINER_NAME $PORTS --env-file .env $IMAGE_NAME

      - name: Health check
        run: |
          sleep 10
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.MASTER_URL || 'http://' }}${{ secrets.EC2_HOST }}:3001/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "Health check failed with status: $response"
            exit 1
          fi
          echo "Health check passed"

